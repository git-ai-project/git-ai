name: End-to-End Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  merge_group:
    branches: [main]

jobs:
  install-local-unix:
    name: E2E ${{ matrix.agent.name }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        agent:
          - name: claude
            npm_pkg: "@anthropic-ai/claude-code"
          - name: codex
            npm_pkg: "@openai/codex"
          - name: gemini
            npm_pkg: "@google/gemini-cli"
          - name: opencode
            npm_pkg: "opencode"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build git-ai
        run: cargo build --release --bin git-ai

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install agent CLI — ${{ matrix.agent.name }}
        run: npm install -g "${{ matrix.agent.npm_pkg }}"

      - name: Prepare test home
        run: |
          TEST_HOME="$RUNNER_TEMP/git-ai-home"
          mkdir -p "$TEST_HOME/.config/fish"
          touch "$TEST_HOME/.bashrc" "$TEST_HOME/.zshrc" "$TEST_HOME/.config/fish/config.fish"
          echo "HOME=$TEST_HOME" >> "$GITHUB_ENV"

      - name: Run install.sh with local binary
        env:
          GIT_AI_LOCAL_BINARY: ${{ github.workspace }}/target/release/git-ai
        run: |
          chmod +x ./install.sh
          ./install.sh

      - name: Verify shell configs and agent hooks
        run: |
          INSTALL_DIR="$HOME/.git-ai/bin"
          test -x "$INSTALL_DIR/git-ai"
          grep -F "$INSTALL_DIR" "$HOME/.bashrc"
          grep -F "$INSTALL_DIR" "$HOME/.zshrc"
          grep -F "fish_add_path -g \"$INSTALL_DIR\"" "$HOME/.config/fish/config.fish"
          bash "$GITHUB_WORKSPACE/scripts/nightly/verify-hook-wiring.sh" "${{ matrix.agent.name }}"

  install-local-windows:
    name: E2E ${{ matrix.agent.name }} on windows-latest
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        agent:
          - name: claude
            npm_pkg: "@anthropic-ai/claude-code"
          - name: codex
            npm_pkg: "@openai/codex"
          - name: gemini
            npm_pkg: "@google/gemini-cli"
          - name: opencode
            npm_pkg: "opencode"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build git-ai
        run: cargo build --release --bin git-ai

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install agent CLI — ${{ matrix.agent.name }}
        run: npm install -g "${{ matrix.agent.npm_pkg }}"

      - name: Prepare test home
        shell: pwsh
        run: |
          $testHome = Join-Path $env:RUNNER_TEMP "git-ai-home"
          New-Item -ItemType Directory -Force -Path $testHome | Out-Null
          $homeDrive = [System.IO.Path]::GetPathRoot($testHome).TrimEnd('\')
          $homePath = $testHome.Substring($homeDrive.Length)
          Add-Content -Path $env:GITHUB_ENV -Value "TEST_HOME=$testHome"
          Add-Content -Path $env:GITHUB_ENV -Value "TEST_HOME_DRIVE=$homeDrive"
          Add-Content -Path $env:GITHUB_ENV -Value "TEST_HOME_PATH=$homePath"

      - name: Run install.ps1 with local binary
        shell: pwsh
        env:
          GIT_AI_LOCAL_BINARY: ${{ github.workspace }}\target\release\git-ai.exe
          HOME: ${{ env.TEST_HOME }}
          USERPROFILE: ${{ env.TEST_HOME }}
          HOMEDRIVE: ${{ env.TEST_HOME_DRIVE }}
          HOMEPATH: ${{ env.TEST_HOME_PATH }}
        run: |
          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          ./install.ps1

      - name: Verify agent hooks
        shell: pwsh
        env:
          HOME: ${{ env.TEST_HOME }}
          USERPROFILE: ${{ env.TEST_HOME }}
          HOMEDRIVE: ${{ env.TEST_HOME_DRIVE }}
          HOMEPATH: ${{ env.TEST_HOME_PATH }}
        run: |
          $installDir = Join-Path $env:USERPROFILE ".git-ai\bin"
          if (-not (Test-Path -LiteralPath (Join-Path $installDir "git-ai.exe"))) { throw "git-ai.exe not installed" }
          switch ("${{ matrix.agent.name }}") {
            "claude" {
              $settings = Join-Path $env:USERPROFILE ".claude\settings.json"
              if (-not (Select-String -Path $settings -Pattern "checkpoint claude")) { throw "Claude hooks not configured" }
            }
            "codex" {
              $config = Join-Path $env:USERPROFILE ".codex\config.toml"
              if (-not (Select-String -Path $config -Pattern "checkpoint codex")) { throw "Codex hooks not configured" }
            }
            "gemini" {
              $settings = Join-Path $env:USERPROFILE ".gemini\settings.json"
              if (-not (Select-String -Path $settings -Pattern "checkpoint gemini")) { throw "Gemini hooks not configured" }
            }
            "opencode" {
              $plugin = Join-Path $env:USERPROFILE ".config\opencode\plugin\git-ai.ts"
              if (-not (Test-Path -LiteralPath $plugin)) { throw "OpenCode plugin not installed" }
            }
          }
